services:
  postgres:
    image: postgres:15
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-iiagent}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-iiagent}
      POSTGRES_DB: ${POSTGRES_DB:-iiagentdev}
      SANDBOX_DB_NAME: ${SANDBOX_DB_NAME:-ii_sandbox}
    env_file:
      - .stack.env
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres-init/create-databases.sh:/docker-entrypoint-initdb.d/create-databases.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-iiagent} -d ${POSTGRES_DB:-iiagentdev}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend:
    build:
      context: ..
      dockerfile: docker/frontend/Dockerfile
      args:
        BUILD_MODE: ${FRONTEND_BUILD_MODE:-production}
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
        VITE_GOOGLE_CLIENT_ID: ${VITE_GOOGLE_CLIENT_ID:-}
        VITE_STRIPE_PUBLISHABLE_KEY: ${VITE_STRIPE_PUBLISHABLE_KEY:-}
        VITE_SENTRY_DSN: ${VITE_SENTRY_DSN:-}
        VITE_DISABLE_CHAT_MODE: ${VITE_DISABLE_CHAT_MODE:-false}
    restart: unless-stopped
    env_file:
      - .stack.env
    environment:
      NODE_ENV: production
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
    ports:
      - "${FRONTEND_PORT:-1420}:1420"
    volumes:
      - ~/.ii_agent/workspace:/.ii_agent/workspace

  tool-server:
    build:
      context: ..
      dockerfile: docker/backend/Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .stack.env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      GOOGLE_APPLICATION_CREDENTIALS: /app/google-application-credentials.json
    entrypoint: ["/bin/sh", "-c"]
    command:
      - >-
        exec uvicorn tool_server.integrations.app.main:app
        --host 0.0.0.0
        --port 1236
    ports:
      - "${TOOL_SERVER_PORT:-1236}:1236"
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS:-./docker/.dummy-credentials.json}:/app/google-application-credentials.json:ro
      - ii-agent-filestore:/.ii_agent
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:1236/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

  sandbox-server:
    build:
      context: ..
      dockerfile: docker/backend/Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - .stack.env
    environment:
      SANDBOX_DATABASE_URL: ${SANDBOX_DATABASE_URL}
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: ${SANDBOX_SERVER_PORT:-8100}
      REDIS_URL: redis://redis:6379/0
      MCP_PORT: ${MCP_PORT:-6060}
    entrypoint: ["/bin/bash", "/app/start_sandbox_server.sh"]
    ports:
      - "${SANDBOX_SERVER_PORT:-8100}:8100"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8100/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ..
      dockerfile: docker/backend/Dockerfile
    init: true
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      sandbox-server:
        condition: service_started
      tool-server:
        condition: service_started
    env_file:
      - .stack.env
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: /app/google-application-credentials.json
      DATABASE_URL: ${DATABASE_URL}
      SANDBOX_SERVER_URL: http://sandbox-server:${SANDBOX_SERVER_PORT:-8100}
      TOOL_SERVER_URL: ${PUBLIC_TOOL_SERVER_URL}
      REDIS_SESSION_URL: redis://redis:6379/1
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS:-./docker/.dummy-credentials.json}:/app/google-application-credentials.json:ro
      - ii-agent-filestore:/.ii_agent
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5

  ngrok:
    image: ngrok/ngrok:3
    restart: unless-stopped
    depends_on:
      tool-server:
        condition: service_started
    env_file:
      - .stack.env
    entrypoint: ["/bin/sh", "-c"]
    command:
      - >-
        exec ngrok http --log=stdout --log-level=info
        --region ${NGROK_REGION:-us}
        ${NGROK_AGENT_EXTRA_ARGS:-}
        tool-server:1236
    ports:
      - "${NGROK_METRICS_PORT:-4040}:4040"

volumes:
  postgres-data:
  redis-data:
  ii-agent-filestore:
